<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PostNet - Mi Perfil</title>
    <link rel="stylesheet" href="myProfile.css">
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
</head>
<body>

    <!-- Barra Lateral -->
    <div class="sidebar">
        <a href="main.html"><i class="fas fa-home"></i><br></a>
        <a href="likes.html"><i class="fas fa-heart"></i><br></a>
        <a href="nuevaPublicacion.html"><i class="fas fa-plus"></i><br></a> <!-- Nuevo bot√≥n para agregar publicaci√≥n -->
        <a href="Notifications.html"><i class="fas fa-bell"></i><br></a>
        <a href="myProfile.html"><i class="fas fa-user"></i><br></a>
    </div>

    <!-- Contenido Principal -->
    <div class="main-container">
        
        <!-- Encabezado con B√∫squeda -->
        <div class="header">
            <h1>PostNet</h1>
            <input type="text" class="search-bar" placeholder="Buscar">
            <button class="search-btn">Buscar</button>
            <!-- Usuario y Cerrar Sesi√≥n -->
            <div class="usuario-header" id="usuarioHeader">
                <span id="nombreUsuario">Usuario</span>
                <button class="cerrar-btn" onclick="cerrarSesion()">Cerrar sesi√≥n</button>
            </div>
        </div>

                  <!-- Perfil -->
        <div class="profile-container">
            <div class="profile-header">
                <div class="profile-info">
                    <!-- Avatar circular -->
                    <div class="profile-avatar" id="profileAvatar">T</div>
                    <div>
                        <strong id="profileName">myProfile</strong>
                      <p id="followersCount" style="color: #bbbbbb; font-size: 12px;">50 Followers</p>
                        <!-- Elemento para mostrar la biograf√≠a -->
                        <p id="profileBio"></p>
                    </div>
                </div>
                <button class="edit-btn" onclick="editarPerfil()">EDITAR</button>
            </div>
            <div class="profile-tabs">
                <span>Publicaciones</span>
                <span>Respuestas</span>
                <span>Repost</span>
            </div>
        </div>

        <!-- Publicaciones -->
        <div class="post-container">
            <div class="post-header">
                <div class="user-avatar">T</div>
                <span><strong>Usuario T</strong></span>
            </div>
            <p class="post-text">Mi primera publicaci√≥n en PostNet.</p>
            <div class="post-image"></div>
            <div class="likes"><i class="fas fa-heart"></i> 15 Me gusta</div>
        </div>

    </div>
<script>
    document.addEventListener("DOMContentLoaded", () => {
    let usuario = JSON.parse(localStorage.getItem('usuario'));

    if (!usuario) {
        // Si no existe en localStorage, lo busco en sessionStorage
        usuario = JSON.parse(sessionStorage.getItem('usuario'));
    }

    if (usuario) {
        document.getElementById("nombreUsuario").textContent = usuario.nombre;
        console.log(usuario.email); // Muestra el nombre del usuario en la consola
        obtenerDatosUsuario(usuario.email); // Llama a la funci√≥n para obtener datos del usuario
        //obtenerPublicaciones(usuario.id_usuario); // Llama a la funci√≥n para obtener publicaciones del usuario
    } else {
        location.href = "login.html"; // Redirige si no est√° logueado en ninguna de las dos
    }
});


function obtenerDatosUsuario(email) {
    $.ajax({
        url: '../BACKEND/Controlador/Usuario_select.php',
        type: 'POST',
        data: { email: email },
        success: function (response) {
    
            
            // 1. Convertir la respuesta en objeto JS
            let res = JSON.parse(response);

            // 2. Verificar que status sea 'success'
            if (res.status === 'success' && res.data.length > 0) {
                let userData = res.data[0]; 
                
                // 3. Insertar datos en el HTML
                
                // Nombre en la esquina superior
                document.getElementById("nombreUsuario").textContent = userData.nombre;
                
                // Muestra nombre + apellido en el perfil
                document.getElementById("profileName").textContent = userData.nombre + " " + userData.apellido;

                // Bio
                document.getElementById("profileBio").textContent = userData.bio ? userData.bio : "";

                // Si deseas usar la inicial del nombre cuando no hay avatar
                if (userData.nombre && userData.nombre.length > 0) {
                    document.getElementById("profileAvatar").textContent = userData.nombre.charAt(0).toUpperCase();
                }

                // Si userData.avatar no es null, mostramos la imagen
                if (userData.avatar) {
                    let avatarBase64 = "data:image/jpeg;base64," + userData.avatar;
                    let avatarElem = document.getElementById("profileAvatar");
                    
                    // Limpiar texto (inicial) y poner la imagen
                    avatarElem.innerHTML = "";
                    let imgTag = document.createElement("img");
                    imgTag.src = avatarBase64;
                    imgTag.alt = "Avatar";
                    // Ajustamos el tama√±o seg√∫n el contenedor
                    imgTag.style.width = "100%";
                    imgTag.style.height = "100%";
                    // Para que sea circular
                    imgTag.style.borderRadius = "50%";
                    imgTag.style.objectFit = "cover";

                    avatarElem.appendChild(imgTag);
                }

                // 4. Guardamos en localStorage la info actualizada (opcional)
                localStorage.setItem('usuario', JSON.stringify(userData));
                console.log(userData.id_usuario);
                obtenerPublicaciones(userData.id_usuario);   // <<‚Äî‚Äî aqu√≠ llamamos a la funci√≥n para obtener publicaciones

            } else {
                console.log("No se encontr√≥ usuario o status !== success");
            }
        },
        error: function (xhr, status, error) {
            console.error(error);
            alert("‚ùå Error al conectar con el servidor.");
        }
    });
}

//PUBLICACIONES 

function obtenerPublicaciones(idUsuario) {
    $.ajax({
        url: '../BACKEND/Controlador/Publicacion_select.php',
        type: 'POST',
        data: { id_usuario: idUsuario },
        dataType: 'json',              // <<<<<<
        success: function (res) {      // jQuery ya lo parse√≥
            if (res.status === 'success') {
                console.log(res.data); // Para depuraci√≥n
                renderizarPublicaciones(res.data);
            } else {
                console.error(res.message);
            }
        },
        error: function (xhr, _s, _e) {
            console.error('Respuesta cruda del servidor:', xhr.responseText);
        }
    });
}

/* ---------- helpers ---------- */
function openModalElem(elem){
  const o = document.createElement('div');
  o.className='modal-overlay';
  const c = document.createElement('div');
  c.className='modal-content'; c.appendChild(elem);
  const x = document.createElement('span');
  x.className='modal-close'; x.innerHTML='&times;';
  x.onclick = ()=>o.remove();
  o.append(c,x); o.onclick=e=>{ if(e.target===o) o.remove(); };
  document.body.appendChild(o);
}

function buildPlusOverlay(count){
  const wrap = document.createElement('div');
  wrap.style.position='relative';
  wrap.style.cursor='pointer';
  wrap.innerHTML=`<div style="
        position:absolute;inset:0;background:rgba(0,0,0,.55);
        display:flex;align-items:center;justify-content:center;
        font-size:40px;color:#fff;border-radius:6px;">+${count}</div>`;
  return wrap;
}

/* ---------- Modal-Carrusel (imagenes + videos) ---------- */
function openCarouselModal(mediaArr, startIdx = 0){
  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';

  /* track con diapositivas */
  const track = document.createElement('div');
  track.className = 'carousel-track';
  track.style.height = '80vh';                // alto m√°ximo del modal

  mediaArr.forEach(item=>{
    if(item.type === 'img'){
      const im = new Image();
      im.src = `data:image/jpeg;base64,${item.src}`;
      im.style.objectFit = 'contain';
      track.appendChild(im);
    }else{
      const v = document.createElement('video');
      v.src = item.src; v.controls = true; v.style.objectFit='contain';
      track.appendChild(v);
    }
  });

  /* contenedor + nav */
  const modalCar = document.createElement('div');
  modalCar.className = 'carousel';
  modalCar.style.height = '80vh';
  modalCar.appendChild(track);

  let idx = startIdx;
  move(0);                                     // posici√≥n inicial

  const prev = navBtn('prev',-1);
  const next = navBtn('next', 1);
  modalCar.append(prev,next);

  function navBtn(cls,dir){
    const b=document.createElement('button');
    b.className=`nav ${cls}`; b.innerHTML = cls==='prev'?'&#10094;':'&#10095;';
    b.onclick=()=>move(dir);
    return b;
  }
  function move(d){
    idx = (idx + d + mediaArr.length) % mediaArr.length;
    track.style.transform = `translateX(-${idx*100}%)`;
  }

  /* overlay + close */
  const close = document.createElement('span');
  close.className='modal-close'; close.innerHTML='&times;';
  close.onclick = ()=>overlay.remove();

  overlay.append(modalCar, close);
  overlay.onclick = e=>{ if(e.target===overlay) overlay.remove(); };

  document.body.appendChild(overlay);
}


/* ---------- funci√≥n principal ---------- */
function renderizarPublicaciones(filas){
  /* 1. Agrupar por id_post */
  const map = {};
  filas.forEach(r => {
    if (!map[r.id_post]) {
        map[r.id_post] = {
            id_post  : r.id_post,
            fecha    : r.fecha_post,
            contenido: r.contenido,
            likes    : r.LIKES ?? 0,
            nombre   : r.nombre ?? 'Yo',
            imagenes : [],
            videos   : []
        };
    }

    if (r.imagen) map[r.id_post].imagenes.push(r.imagen);

    /* üëâ a√±ade solo si no existe todav√≠a */
    if (r.ruta_video && !map[r.id_post].videos.includes(r.ruta_video)) {
        map[r.id_post].videos.push(r.ruta_video);
    }
});


  /* 2. Ordenar m√°s reciente primero */
  const posts = Object.values(map).sort((a,b)=>b.id_post-a.id_post);

  /* 3. Vaciar contenedor */
  const cont = document.querySelector('.main-container');
  cont.querySelectorAll('.post-container').forEach(e=>e.remove());

  /* 4. Pintar */
  const user = JSON.parse(localStorage.getItem('usuario')) || {};
  posts.forEach(p=>{
    const box = document.createElement('div');
    box.className='post-container';

    /* encabezado */
    const head = document.createElement('div');
    head.className='post-header';
    const av   = document.createElement('div');
    av.className='user-avatar';
    if(user.avatar){
      av.innerHTML=`<img src="data:image/jpeg;base64,${user.avatar}">`;
    }else{
      av.textContent=(user.nombre?.charAt(0) || 'U').toUpperCase();
    }
    head.append(av,
      Object.assign(document.createElement('span'),{
        innerHTML:`<strong>${user.nombre + user.apellido??'Usuario'}</strong>`}));
    box.appendChild(head);

    /* texto */
    if(p.contenido){
      const txt=document.createElement('p');
      txt.className='post-text'; txt.textContent=p.contenido;
      box.appendChild(txt);
    }

    /* ---------- IMAGENES ---------- */
    if(p.imagenes.length){
      if(p.imagenes.length<=4){                           // grid 1-4
        const g=document.createElement('div');
        g.className=`post-gallery cols-${p.imagenes.length}`;
        p.imagenes.forEach(src=>{
          const img=new Image(); img.src=`data:image/jpeg;base64,${src}`;
          img.onclick=()=>openModalElem(img.cloneNode());
          g.appendChild(img);
        });
        box.appendChild(g);
      }else{                                              // >4: grid 2√ó2 + overlay
        const g = document.createElement('div');
    g.className = 'post-gallery cols-4';

    const firstFour = p.imagenes.slice(0, 4);
    firstFour.forEach((src, i) => {
        const img = new Image();
        img.src = `data:image/jpeg;base64,${src}`;
        img.onclick = () => openCarouselModal(
            [...p.imagenes.map(s=>({type:'img',src:s})),
             ...p.videos.map(v=>({type:'vid',src:`../${v}`}))],
            i                                          // empezar en la que clican
        );
        if (i === 3) {                                // √∫ltimo con overlay
            const wrap = buildPlusOverlay(p.imagenes.length - 4);
            wrap.appendChild(img);                    // imagen dentro del overlay
            wrap.onclick = () => openCarouselModal(
                [...p.imagenes.map(s=>({type:'img',src:s})),
                 ...p.videos.map(v=>({type:'vid',src:`../${v}`}))],
                3                                     // arranca en 4¬™ miniatura
            );
            g.appendChild(wrap);
        } else {
            g.appendChild(img);
        }
    });
    box.appendChild(g);                 // a√±adimos el grid al post

      }
    }

/* ---------- VIDEOS ---------- */
if (p.videos.length) {

/* ¬øHay im√°genes? ‚Üí NO pintes videos en el feed */
const hayFotos = p.imagenes.length > 0;
if (hayFotos) {
    /* El video se ver√° en el modal junto a las im√°genes */
    // Nada que a√±adir al feed
} else {

    /* ----- sin im√°genes, pinta videos ----- */
    if (p.videos.length === 1) {          // un solo video ancho
        const v = document.createElement('video');
        v.src = `../${p.videos[0]}`;
        v.controls = true;
        v.className = 'post-video';
        v.onclick = () => openCarouselModal(
            [{ type: 'vid', src: v.src }],
            0
        );
        box.appendChild(v);

    } else if (p.videos.length <= 4) {    // 2-4 videos: grid
        const vg = document.createElement('div');
        vg.className = `post-video-grid cols-${p.videos.length}`;
        p.videos.forEach((ruta, idx) => {
            const v = document.createElement('video');
            v.src = `../${ruta}`;
            v.controls = true;
            v.onclick = () => openCarouselModal(
                p.videos.map(s => ({ type: 'vid', src: `../${s}` })),
                idx
            );
            vg.appendChild(v);
        });
        box.appendChild(vg);

    } else {                              // >4 videos: carrusel
        box.appendChild(crearCarruselVideos(p.videos));
    }
}
}


    /* likes */
    const lk=document.createElement('div');
    lk.className='likes';
    lk.innerHTML=`<i class="fas fa-heart"></i> ${p.likes} Me gusta`;
    box.appendChild(lk);

    cont.appendChild(box);
  });
}






/* ---------- CARRUSEL DE IM√ÅGENES (>4) ---------- */
function crearCarrusel(imgArr){
  const car   = document.createElement('div');
  car.className = 'carousel';

  const track = document.createElement('div');
  track.className = 'carousel-track';

  imgArr.forEach(src=>{
    const im = new Image();
    im.src = `data:image/jpeg;base64,${src}`;
    im.onclick = ()=> openModal(im.cloneNode());     // << modal aqu√≠
    track.appendChild(im);
  });
  car.appendChild(track);

  let idx = 0;
  const prev = navBtn('prev', -1);
  const next = navBtn('next',  1);
  car.append(prev, next);

  function navBtn(cls,dir){
    const b = document.createElement('button');
    b.className = `nav ${cls}`;
    b.innerHTML  = cls==='prev' ? '&#10094;' : '&#10095;';
    b.onclick    = ()=> mover(dir);
    return b;
  }
  function mover(d){
    idx = (idx + d + imgArr.length) % imgArr.length;
    track.style.transform = `translateX(-${idx*100}%)`;
  }
  return car;
}

/* ---------- CARRUSEL DE VIDEOS (>4) ---------- */
function crearCarruselVideos(videos){
  const car   = document.createElement('div');
  car.className = 'carousel';

  const track = document.createElement('div');
  track.className = 'carousel-track';

  videos.forEach(ruta=>{
    const v = document.createElement('video');
    v.src = `../${ruta}`;
    v.controls = true;
    v.onclick  = ()=>{
        const big = document.createElement('video');
        big.src = v.src; big.controls = true; big.autoplay = true;
        openModal(big);                               // << modal aqu√≠
    };
    track.appendChild(v);
  });
  car.appendChild(track);

  let idx = 0;
  const prev = navBtn('prev',-1);
  const next = navBtn('next', 1);
  car.append(prev,next);

  function navBtn(cls,dir){
    const b = document.createElement('button');
    b.className = `nav ${cls}`;
    b.innerHTML = cls==='prev' ? '&#10094;' : '&#10095;';
    b.onclick   = ()=> mover(dir);
    return b;
  }
  function mover(d){
    idx = (idx + d + videos.length) % videos.length;
    track.style.transform = `translateX(-${idx*100}%)`;
  }
  return car;
}

//PUBLICACIONES 


//END
function cerrarSesion() {
    localStorage.removeItem('usuario');
    sessionStorage.removeItem('usuario');
    location.href = "login.html";
}

function editarPerfil() {
    // Redirigir a la p√°gina de edici√≥n de perfil
    location.href = "edit_profile.html";
}

</script>
</body>
</html>
